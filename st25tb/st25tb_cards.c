/*  Benjamin DELPY `gentilkiwi`
    https://blog.gentilkiwi.com
    benjamin@gentilkiwi.com
    Licence : https://creativecommons.org/licenses/by/4.0/
*/
#include "st25tb_cards.h"
#include <string.h>

#if defined(__MSP430F5529__)
__attribute__ ((aligned (0x200), section(".stcard")))
#endif
const uint8_t MyRefSt_Flash[0x10 + 1 + 2][4] =
{
    { 0x00, 0x00, 0x00, 0x00 }, // 0x00
    { 0x00, 0x00, 0x00, 0x00 }, // 0x01
    { 0x00, 0x00, 0x00, 0x00 }, // 0x02
    { 0x00, 0x00, 0x00, 0x00 }, // 0x03
    { 0x00, 0x00, 0x00, 0x00 }, // 0x04
    { 0xff, 0xff, 0xff, 0xff }, // 0x05
    { 0xff, 0xff, 0xff, 0xff }, // 0x06
    { 0x00, 0x00, 0x00, 0x00 }, // 0x07
    { 0x00, 0x00, 0x00, 0x00 }, // 0x08
    { 0x00, 0x00, 0x00, 0x00 }, // 0x09
    { 0x00, 0x00, 0x00, 0x00 }, // 0x0a
    { 0x00, 0x00, 0x00, 0x00 }, // 0x0b
    { 0x00, 0x00, 0x00, 0x00 }, // 0x0c
    { 0x00, 0x00, 0x00, 0x00 }, // 0x0d
    { 0x00, 0x00, 0x00, 0x00 }, // 0x0e
    { 0x00, 0x00, 0x00, 0x00 }, // 0x0f
    // ...
    { 0xff, 0xff, 0xff, 0xff }, // 0xff (0x10)
    // ...
    { 0xee, 0xdd, 0xcc, 0xbb }, // 0x7e (0x11)
    { 0xaa, 0x33, 0x02, 0xd0 }, // 0x7f (0x12)
    // ...
};

uint8_t ST25TB_CARDS_CurrentCard[0x10 + 1 + 2][4];

void ST25TB_CARDS_toSlot(uint8_t slotNumber)
{
#if defined(__MSP430F5529__)
    FlashCtl_eraseSegment((uint8_t *) MyRefSt_Flash);
    FlashCtl_write32((uint32_t *) ST25TB_CARDS_CurrentCard, (uint32_t *) MyRefSt_Flash, sizeof(MyRefSt_Flash) / sizeof(MyRefSt_Flash[0]));
#elif defined(__MSP430FR2476__)
    FRAMCtl_write32((uint32_t *) ST25TB_CARDS_CurrentCard, (uint32_t *) MyRefSt_Flash, sizeof(MyRefSt_Flash) / sizeof(MyRefSt_Flash[0]));
#else
#error Target is not supported !
#endif
}

void ST25TB_CARDS_fromSlot(uint8_t slotNumber) // 76 bytes :')
{
    memcpy(ST25TB_CARDS_CurrentCard, MyRefSt_Flash, sizeof(MyRefSt_Flash));
}
